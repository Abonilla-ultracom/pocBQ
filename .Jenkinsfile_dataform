// Inicio 

// Inicializar el entorno de Jenkins
pipeline {
    agent any 
    
    // Definir un entorno para el flujo de trabajo
    environment {
        GCP_PROJECT = "poc-ci-cd-375313" 
        GCP_PROJECT_NAME = "poc-ci-cd"
        GOOGLE_APPLICATION_CREDENTIALS = credentials('poc-ci-cd')
        GOOGLE_CLOUD_KEYFILE_JSON = credentials('poc-ci-cd')
    }
    
    // Definir un punto de inicio para el flujo de trabajo
    stages {
        stage('Inicio') {
            steps {
                echo 'Iniciando el flujo de trabajo...'
            }
        }
        
        // Conectar con el proyecto de GCP
        stage('Conexi√≥n GCP') {
            steps {
                echo 'Conectando con el proyecto de GCP ...'
                withCredentials([file(credentialsId: 'jenkins_secret', variable: 'private_key')]) {
                sh("gcloud auth activate-service-account --key-file=${private_key}")
                sh("gcloud container clusters get-credentials prod --zone northamerica-northeast1-a --project ${project}")
                  
                }
                
              }
          }
        
        // Desplegar los cambios en Dataform
        stage('Dataform') {
            steps {
                echo 'Desplegando los cambios en Dataform ...'
                sh 'dataform deploy --project $GCP_PROJECT --source-repo gitlab://<mi-grupo>/<mi-proyecto>#master'
            }
        }
    }
}

// Fin